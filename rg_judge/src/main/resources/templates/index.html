<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
</head>
    <body>
        <div class="container">
            <h1><br>RG Judging Support System</h1>
            <p>Выберите элемент, загрузите видео, и система оценит его по правилам художественной гимнастики<br></p>
        </div>

        <div class="container">
            <div class="dropdown">
                <a class="btn btn-secondary dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
                    Выберите элемент
                </a>

                <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
<!--                    Здесь будут элементы-->
                </ul>
            </div>
            <br>
            <input type="file" id="videoFile" accept="video/*" style="display:none">
            <button class="btn btn-primary" id="uploadButton">Загрузите видео</button>
            <button class="btn btn-primary" id="sendButton" disabled>Оценить</button>
            <div id="loadingSpinner" class="spinner-border text-primary" role="status" style="display: none;">
                <span class="sr-only">Loading...</span>
            </div>
            <br><br>

            <table class="table table-bordered" id="element_table">
                <thead>
                <tr>
                    <th class="table-active" scope="col">Элемент</th>
                    <th class="table-active" scope="col">Стоимость</th>
                    <th class="table-active" scope="col">Засчитан</th>
                    <th class="table-active" scope="col">Сбавки</th>
                    <th class="table-active" scope="col">Итоговая оценка</th>
                    <th class="table-active" scope="col">Ссылка на видео</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                   <!--                    Здесь будет информация об элементе-->
                </tr>
                </tbody>
            </table>
            <br>

            <table class="table table-bordered" id="report_table">
                <thead class="thead-light">
                <tr>
                    <th class="table-active" scope="col">Критерий оценивания</th>
                    <th class="table-active" scope="col">Ожидаемое поведение</th>
                    <th class="table-active" scope="col">Действительное поведение</th>
                    <th class="table-active" scope="col">Сбавки</th>
                    <th class="table-active" scope="col">Элемент засчитан</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <!--                    Здесь будет подробный отчет по оценке-->
                </tr>
                </tbody>
            </table>
        </div>

        <script>
            $(document).ready(function() {
                var elementId = null;
                var videoFile = null;

                $.ajax({
                    url: 'http://localhost:8080/api/v1/element',
                    type: 'GET',
                    success: function(data) {
                        $('.dropdown-menu').empty();
                        $.each(data.body, function(index, item) {
                            var dropdownItem = $('<li>', {
                                class: 'dropdown-item',
                                html: '<a>' + item.name + '</a>'
                            });
                            dropdownItem.attr('id', item.id);
                            $('.dropdown-menu').append(dropdownItem);
                        });
                    },
                    error: function() {
                        console.log('Ошибка при получении данных');
                    }
                });

                $('.dropdown-menu').on('click', 'a', function(e) {
                    e.preventDefault();
                    elementId = $(this).parent().attr('id');
                    selectedText = $(this).text();
                    updateSendButtonState();
                    $('#dropdownMenuLink').text(selectedText);
                });

                $('#uploadButton').click(function() {
                    $('#videoFile').click();
                });

                $('#videoFile').change(function() {
                    videoFile = this.files[0];
                    updateSendButtonState();
                });

                function updateSendButtonState() {
                    if (elementId && videoFile) {
                        $('#sendButton').prop('disabled', false);
                    } else {
                        $('#sendButton').prop('disabled', true);
                    }
                }

                $('#sendButton').click(function() {
                    // Показываем кружочек крутящийся
                    $('#loadingSpinner').show();
                    $('#sendButton').prop('disabled', true);

                    var formData = new FormData();
                    formData.append('elementId', elementId);
                    formData.append('videoFile', videoFile);

                    $.ajax({
                        url: 'http://localhost:8080/api/v1/element/evaluate',
                        type: 'POST',
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function(response) {
                            $('#loadingSpinner').hide();
                            $('#sendButton').prop('disabled', false);
                            var body = response.body

                            var elementTableBody = $('#element_table tbody');
                            elementTableBody.empty();

                            var info = $('<tr>');
                            info.append($('<td>').text(body.elementName));
                            info.append($('<td>').text(body.elementScore));
                            if (body.isValid) {
                                info.append($('<td>').html('&#10003;'));
                            } else {
                                info.append($('<td>').html('&#x2717;'));
                            }
                            info.append($('<td>').text(body.penalty));
                            info.append($('<td>').text(body.finalScore));
                            info.append($('<td>').append($('<a>', {
                                href: body.videoLink,
                                text: body.videoLink
                            })));
                            elementTableBody.append(info);

                            var reportTable = $('#report_table tbody');
                            reportTable.empty();

                            $.each(body.detailedEstimatorReport, function(index, item) {
                                var row = $('<tr>');
                                row.append($('<td>').text(item.estimatorName));
                                row.append($('<td>').text(item.expectedBehavior));
                                row.append($('<td>').text(item.actualBehavior));
                                if (item.penalty !== '0') {
                                    row.append($('<td>', {
                                        class: 'table-warning',
                                        text: item.penalty
                                    }));
                                } else {
                                    row.append($('<td>').text('0.0'));
                                }
                                if (item.isCounted === 'false') {
                                    row.append($('<td>', {
                                        class: 'table-danger',
                                        html: '&#x2717;'
                                    }));
                                } else {
                                    row.append($('<td>', {
                                        class: 'table-success',
                                        html: '&#10003;'
                                    }));
                                }
                                reportTable.append(row);
                            });
                        },
                        error: function() {
                            $('#loadingSpinner').hide();
                            $('#sendButton').prop('disabled', false);
                            console.log('Ошибка при отправке запроса');
                        },
                        xhr: function() {
                            var xhr = new XMLHttpRequest();
                            xhr.upload.addEventListener('progress', function(e) {
                                if (e.lengthComputable) {
                                    var percentComplete = (e.loaded / e.total) * 100;
                                    console.log(percentComplete + '% uploaded');
                                }
                            }, false);
                            return xhr;
                        }
                    });
                });
            });
        </script>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>